- hosts: all
  become: true
  remote_user: ec2-user
  tasks:
    - name: Update instance
      yum:
        name: "*"
        state: latest

    - name: Install docker
      yum:
        name: docker
        state: latest

    - name: Install pip
      yum:
        name: python-pip
        state: latest

    - name: add ec2-user to docker group
      user:
        name: ec2-user
        groups: docker
        append: yes

    - name: start docker
      service:
        name: docker
        state: started

    - name: Archive files
      archive:
        path: ./
        dest: /var/deployment.tar.gz
      delegate_to: localhost

    - name: Copy archive
      copy:
        src: /var/deployment.tar.gz
        dest: /var/deployment.tar.gz

    - name: Create directory /var/deployment/
      file:
        path: /var/deployment/
        state: directory

    - name: Unarchive files
      unarchive:
        src: /var/deployment.tar.gz
        dest: /var/deployment/
        remote_src: yes

    - name: Remove archive
      file:
        path: /var/deployment.tar.gz
        state: absent

    - name: Check if requests is up-to-date
      command: pip show requests | grep Version
      register: requests_version
      changed_when: False

    - name: Upgrade requests
      yum:
        name: "python-requests"
        state: latest
      when: "'2.31.0' not in requests_version.stdout"

    - name: Check if Docker SDK for Python is up-to-date
      command: pip show docker | grep Version
      register: docker_version
      changed_when: False

    - name: Install Docker SDK for Python
      pip:
        name: docker==6.1.3
        extra_args: --ignore-installed requests
        state: present
      when: "'6.1.3' not in docker_version.stdout"

    - name: Check if Docker Compose is up-to-date
      command: pip show docker-compose | grep Version
      register: docker_compose_version
      changed_when: False

    - name: Install Docker Compose
      pip:
        name: docker-compose
        state: present
      when: "'1.2.3' not in docker_compose_version.stdout"

    - name: Create .env file with SITE_ADDRESS
      copy:
        dest: /var/deployment/.env
        content: |
          MONGO_INITDB_ROOT_USERNAME={{ MONGO_INITDB_ROOT_USERNAME }}
          MONGO_INITDB_ROOT_PASSWORD={{ MONGO_INITDB_ROOT_PASSWORD }}
          MONGO_INITDB_DATABASE={{ MONGO_INITDB_DATABASE }}
          MONGODB_USER={{ MONGODB_USER }}
          MONGODB_USER_PASSWORD={{ MONGODB_USER_PASSWORD }}
          SITE_ADDRESS={{ SITE_ADDRESS }}
          NEXT_PUBLIC_BASE_URL=http://{{ SITE_ADDRESS }}:{{ PORT }}/
          PORT={{ PORT }}
          DEBUG={{ DEBUG }}

    - name: Check if network web exists
      command: docker network ls --filter name=^web$ --format={{'.Name'}}
      register: web_network

    - name: Create network web
      shell: docker network create web
      when: web_network.stdout == ""

    - name: Execute docker-compose for Deployement
      docker_compose:
        project_src: /var/deployment/
